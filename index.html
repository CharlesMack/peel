<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
    <title>peel - Lens Simulation & Focus Control</title>
    <style>
        /* Base styles adapted from P.O.P.S. */
        :root {
            --bg: #0a0d14;
            --glass1: rgba(14, 20, 34, .66);
            --glass2: rgba(14, 20, 34, .28);
            --rim: #1e2a45;
            --accent: #7af0ff;
            --accent-2: #00e5ff;
            --warn: #ffcc00;
            --danger: #ff3355;
            --fg: #eaf0ff;
            --muted: #9aacbf;
            --ok: #4ade80;
        }

        * {
            box-sizing: border-box
        }

        html, body {
            height: 100%
        }

        body {
            margin: 0;
            background: radial-gradient(1200px 800px at 30% 0%, #0e1628 0%, #0a0d14 50%, #06080f 100%);
            color: var(--fg);
            font: 500 12px/1.25 system-ui, Inter, Segoe UI, Roboto, Arial;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        .wrap {
            display: grid;
            grid-template-rows: auto 1fr auto;
            height: 100vh;
            gap: 10px;
            padding: 12px;
        }

        .glass {
            background: linear-gradient(180deg, var(--glass1), var(--glass2));
            border: 1px solid rgba(122, 240, 255, .18);
            backdrop-filter: blur(10px);
            border-radius: 14px;
            box-shadow: 0 4px 30px rgba(0, 0, 0, .35);
        }

        .topbar {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            align-items: center;
            padding: 8px 12px;
            gap: 10px;
        }

        .brand {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .chip {
            display: inline-flex;
            gap: 6px;
            align-items: center;
            padding: 6px 10px;
            border: 1px solid var(--rim);
            border-radius: 12px;
            background: linear-gradient(180deg, #141a2b, #0f1525);
        }

        .stat {
            opacity: .9
        }

        .mid {
            display: grid;
            grid-template-columns: 260px 1fr 320px;
            gap: 10px;
            min-height: 0;
        }
        
        .panel {
            padding: 10px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            min-height: 0;
        }

        .section {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .section h3 {
            margin: 0 0 6px 0;
            font-weight: 700;
            letter-spacing: .02em;
            color: #c7d2fe;
        }

        .row {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        select, input[type="number"], button {
            background: #0e172a;
            color: var(--fg);
            border: 1px solid var(--rim);
            padding: 6px 8px;
            border-radius: 10px;
            font: inherit;
        }

        button {
            cursor: pointer;
        }

        button.prim {
            border-color: var(--accent);
            box-shadow: 0 0 0 1px rgba(122, 240, 255, .2) inset;
        }

        button.rec {
            background: linear-gradient(180deg, #3b0b18, #1a0911);
            border-color: #6b0d22;
        }

        button.rec.live {
            background: linear-gradient(180deg, #ff3355, #a80e2d);
            color: white;
            border-color: #ff3355;
            box-shadow: 0 0 12px rgba(255, 51, 85, .5);
        }

        .meter {
            height: 8px;
            border-radius: 999px;
            background: #0e172a;
            border: 1px solid var(--rim);
            overflow: hidden;
        }

        .meter > span {
            display: block;
            height: 100%;
            background: linear-gradient(90deg, var(--accent), #18e7ff);
        }

        /* Viewfinder */
        .vf {
            position: relative;
            overflow: hidden;
            border-radius: 14px;
            border: 1px solid var(--rim);
            background: #000;
        }

        .vf .feed, .vf .bars, .vf .grain {
            position: absolute;
            inset: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .vf .feed {
            z-index: 1;
        }

        .vf .bars {
            opacity: 0;
            pointer-events: none;
            mix-blend-mode: screen;
        }

        .vf .test {
            position: absolute;
            inset: 0;
            background: linear-gradient(90deg, #f00, #ff0, #0f0, #0ff, #00f, #f0f, #f00);
        }

        .vf .frame-guides {
            position: absolute;
            inset: 0;
            pointer-events: none;
            z-index: 5;
        }

        .vf .safe {
            position: absolute;
            inset: 6% 7%;
            border: 1px solid rgba(255, 255, 255, .24);
        }

        .vf .letterbox {
            position: absolute;
            left: 0;
            right: 0;
            background: #000;
            opacity: .85;
        }

        .vf .letterbox.top {
            top: 0;
        }

        .vf .letterbox.bot {
            bottom: 0;
        }

        .vf .focus {
            position: absolute;
            inset: 0;
            mix-blend-mode: screen;
            opacity: 0;
        }

        .vf .grain {
            position: absolute;
            inset: 0;
            pointer-events: none;
            mix-blend-mode: overlay;
            opacity: .25;
            z-index: 4;
        }
        
        /* Fixed ND filter z-index to ensure visibility */
        .vf .nd {
            position: absolute;
            inset: 0;
            background: #000;
            opacity: 0;
            pointer-events: none;
            z-index: 2; 
        }

        .vf .tc {
            position: absolute;
            bottom: 10px;
            left: 12px;
            background: rgba(0, 0, 0, .5);
            padding: 4px 8px;
            border-radius: 8px;
            font-weight: 700;
            z-index: 5;
        }

        .vf .badge {
            position: absolute;
            top: 10px;
            left: 12px;
            display: flex;
            gap: 6px;
            z-index: 5;
        }

        .vf .badge .b {
            padding: 4px 8px;
            border-radius: 8px;
            background: rgba(0, 0, 0, .55);
            border: 1px solid rgba(255, 255, 255, .15);
        }
        
        .vf .flare {
            position: absolute;
            inset: 0;
            pointer-events: none;
            z-index: 3;
            mix-blend-mode: screen;
            opacity: 0;
        }
        
        .vf .flare.on {
            opacity: 1;
            transition: opacity 0.5s;
        }

        /* Sliders */
        .kv {
            display: grid;
            grid-template-columns: 110px 1fr;
            gap: 8px;
            align-items: center;
        }

        .vslider {
            height: 160px;
            display: flex;
            gap: 10px;
        }

        .vslider input[type="range"] {
            -webkit-appearance: none;
            width: 20px;
            height: 160px;
            writing-mode: vertical-lr;
            direction: rtl;
            background: transparent;
            outline: none;
        }

        .vslider input[type="range"]::-webkit-slider-runnable-track {
            background: linear-gradient(180deg, #101a2f, #0b1121);
            border: 1px solid var(--rim);
            width: 6px;
            border-radius: 999px;
        }

        .vslider input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: radial-gradient(circle at 35% 35%, #fff, #bdf4ff 60%, #10c8e8 61%);
            margin-top: -6px;
            border: 1px solid #0bbbd8;
            box-shadow: 0 0 10px rgba(16, 200, 232, .6);
        }

        .focus-wheel-wrap {
            position: relative;
            width: 100px;
            height: 100px;
            margin: 0 auto;
            border-radius: 50%;
            background-color: var(--rim);
            border: 1px solid var(--accent);
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            overflow: hidden;
            box-shadow: 0 0 10px rgba(122,240,255,.2);
        }

        .focus-wheel {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: conic-gradient(from 0deg, var(--glass2) 0%, var(--glass1) 50%, var(--glass2) 100%);
            animation: rotate 10s infinite linear;
        }
        
        .focus-wheel-center {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background-color: var(--rim);
            border: 1px solid var(--accent);
            z-index: 10;
        }
        
        @keyframes rotate {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .foot {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 12px;
            gap: 10px;
        }

        .foot .left, .foot .right {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .badge2 {
            padding: 6px 10px;
            border-radius: 10px;
            border: 1px solid var(--rim);
            background: rgba(14, 20, 34, .6);
        }

        .roger {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .roger button {
            width: 38px;
            height: 38px;
            border-radius: 50%;
            display: grid;
            place-items: center;
        }

        .mic.on {
            border-color: var(--ok);
            box-shadow: 0 0 12px rgba(74, 222, 128, .5);
        }

        /* Multi-cam grid */
        .multi-cam-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            grid-gap: 5px;
            padding: 5px;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 10px;
        }

        .multi-cam-grid video {
            width: 100%;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
        }

        /* Take Bin */
        .bin {
            display: flex;
            flex-direction: column;
            gap: 8px;
            overflow: auto;
            min-height: 140px;
            border-top: 1px dashed rgba(122, 240, 255, .25);
            padding-top: 8px;
        }

        .take {
            display: grid;
            grid-template-columns: 1fr auto auto;
            gap: 8px;
            align-items: center;
            border: 1px solid var(--rim);
            border-radius: 10px;
            padding: 6px 8px;
            background: rgba(10, 13, 20, .55);
        }

        .take .meta {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }

        .take video {
            max-width: 160px;
            border: 1px solid var(--rim);
            border-radius: 8px;
        }

        @media (max-width: 1100px) {
            .mid {
                grid-template-columns: 1fr;
                grid-template-rows: auto 1fr auto;
            }
        }
        
        .hidden-file-input {
            display: none;
        }

    </style>
</head>
<body>
    <div class="wrap">
        <!-- TOP BAR -->
        <div class="topbar glass">
            <div class="brand">
                <div class="chip"><strong>peel</strong> <span class="stat">Lens Simulator</span></div>
                <div class="chip">Project: <span id="projName">Untitled</span></div>
                <div class="chip">Clip: <span id="clipId">A001_C001</span></div>
            </div>
            <div class="row" style="justify-content:center">
                <div class="chip">Res:
                    <select id="resSel">
                        <option>4.6K</option>
                        <option>4K</option>
                        <option>3.3K</option>
                        <option>3K</option>
                        <option>2.7K</option>
                        <option>2K</option>
                    </select>
                </div>
                <div class="chip">FPS:
                    <select id="fpsSel">
                        <option>24</option>
                        <option>25</option>
                        <option>30</option>
                        <option>48</option>
                        <option>60</option>
                        <option>120</option>
                        <option>600</option>
                    </select>
                </div>
                <div class="chip">Aspect:
                    <select id="aspSel">
                        <option>16:9</option>
                        <option selected>2.39:1</option>
                        <option>4:3</option>
                    </select>
                </div>
                <div class="chip">Guides: <label><input id="guides" type="checkbox" checked> On</label></div>
                <button id="useCam" class="prim">Use Camera</button>
            </div>
            <div style="display:flex; justify-content:flex-end; gap:8px; align-items:center">
                <div class="chip">Slices:
                    <span class="stat">HOT <b id="hotPct">62%</b></span> ‚Ä¢
                    <span class="stat">WARM <b id="warmPct">15%</b></span> ‚Ä¢
                    <span class="stat">COLD <b id="coldTB">3.0TB</b> free</span>
                </div>
            </div>
        </div>

        <!-- MID -->
        <div class="mid">
            <!-- LEFT PANEL -->
            <div class="panel glass">
                <div class="section">
                    <h3>Lens & Focus</h3>
                    <div class="kv"><div>Focal Length</div>
                        <div class="row">
                            <input id="focalLength" type="number" min="16" max="200" step="1" value="50" style="width:70px"> mm
                        </div>
                    </div>
                    <div class="kv"><div>Aperture (F-Stop)</div>
                        <div class="row">
                            <input id="aperture" type="number" min="1.4" max="22" step="0.1" value="2.8" style="width:70px"> f/
                        </div>
                    </div>
                    <div class="kv"><div>Focus Distance</div>
                        <input type="range" id="focusDistance" min="0" max="1" step="0.01" value="0.5">
                    </div>
                </div>
                <div class="section">
                    <h3>Look & Color</h3>
                    <div class="kv"><div>LUT</div>
                        <select id="lutSel">
                            <option value="709">LogC4 ‚Üí Rec709</option>
                            <option value="PQ">HDR PQ</option>
                            <option value="FILM">Film Stock</option>
                            <option value="MYTH">P.O.P.S. Mythic</option>
                            <option value="RAW">Bypass (Log Preview)</option>
                            <option value="UPLOAD">Upload Custom</option>
                        </select>
                        <input type="file" id="lutFile" accept=".cube" class="hidden-file-input">
                    </div>
                    <div class="kv"><div>Texture</div>
                        <select id="texSel"><option>Neutral</option><option>Soft</option><option>Gritty</option><option>Dream</option></select>
                    </div>
                    <div class="kv"><div>White Balance</div>
                        <div class="row" style="flex:1">
                            <input id="wbKel" type="number" min="2000" max="10000" step="100" value="5600" style="width:90px">
                            <button data-wb="3200">3200K</button>
                            <button data-wb="4300">4300K</button>
                            <button data-wb="5600">5600K</button>
                            <button data-wb="6500">6500K</button>
                        </div>
                    </div>
                </div>
                <div class="section">
                    <h3>ND Filter</h3>
                    <div class="vslider">
                        <input id="nd" type="range" min="2" max="7" step="0.1" value="2">
                        <div>Stops: <b id="ndVal">2.0</b></div>
                    </div>
                </div>
            </div>

            <!-- VIEWFINDER -->
            <div class="vf glass" id="vf">
                <video id="cam" class="feed" playsinline muted></video>
                <div class="test feed" id="testPattern"></div>
                <div class="bars" id="peaking"></div>
                <div class="grain" id="grain"></div>
                <div class="nd" id="ndOverlay"></div>
                <div class="flare" id="flareOverlay"></div>
                <div class="frame-guides" id="guidesBox">
                    <div class="safe"></div>
                    <div class="letterbox top" id="lbTop" style="height:0"></div>
                    <div class="letterbox bot" id="lbBot" style="height:0"></div>
                </div>
                <div class="badge">
                    <div class="b" id="bFps">24fps</div>
                    <div class="b" id="bRes">4.6K</div>
                    <div class="b" id="bFocal">50mm</div>
                    <div class="b" id="bAperture">f/2.8</div>
                    <div class="b" id="bISO">EI 800</div>
                    <div class="b" id="bShut">180¬∞</div>
                    <div class="b" id="bAna">Anamorphic: Off</div>
                    <div class="b" id="bLut">709</div>
                </div>
                <div class="tc" id="timecode">00:00:00:00</div>
            </div>

            <!-- RIGHT PANEL: Lens/Power + TAKE BIN -->
            <div class="panel glass">
                <div class="section">
                    <h3>Exposure & Camera</h3>
                    <div class="kv"><div>ISO (EI)</div>
                        <div class="row"><button class="decIso">‚àí</button><input id="iso" type="number" step="100" min="160" max="6400" value="800" style="width:90px"><button class="incIso">+</button></div>
                    </div>
                    <div class="kv"><div>Shutter Angle</div>
                        <div class="row"><button class="decSh">‚àí</button><input id="shutter" type="number" step="5" min="45" max="360" value="180" style="width:90px"><button class="incSh">+</button></div>
                    </div>
                    <div class="kv"><div>Anamorphic</div>
                        <select id="anaSel"><option value="1">Off</option><option value="1.3">1.3√ó</option><option value="2">2.0√ó</option></select>
                    </div>
                    <div class="kv"><div>Focus Peaking</div><label><input id="peakChk" type="checkbox"> On (overlay)</label></div>
                    <div class="kv"><div>Lens Flare</div><label><input id="flareChk" type="checkbox"> On (anamorphic)</label></div>
                    <div class="section"><h3>Exposure Meter</h3><div class="kv"><div>EV Offset</div><div id="evText">0.0</div></div></div>
                </div>
                <div class="section">
                    <h3>Multi-Cam Sync</h3>
                    <div class="kv"><div>Session ID</div>
                        <input type="text" id="sessionId" value="session-1">
                    </div>
                    <div class="row">
                        <button id="connectBtn" class="prim">Connect to Session</button>
                        <button id="disconnectBtn">Disconnect</button>
                    </div>
                    <div id="multiCamPreview" class="multi-cam-grid"></div>
                </div>
                <div class="section">
                    <h3>Storage & Power</h3>
                    <div>Battery (B-Mount 24V)</div>
                    <div class="meter"><span id="batBar" style="width:85%"></span></div>
                    <div class="row"><span id="batText">85%</span> ‚Ä¢ <span id="volt">24.0V</span></div>
                    <div style="margin-top:6px">HOT Cache</div>
                    <div class="meter"><span id="hotBar" style="width:62%"></span></div>
                    <div style="margin-top:6px">WARM Archive</div>
                    <div class="meter"><span id="warmBar" style="width:15%"></span></div>
                </div>
                <div class="section">
                    <h3>üé¨ Take Bin</h3>
                    <div class="row">
                        <button id="chooseDir" class="prim" title="Optional: save takes directly into a folder">Set Save Folder</button>
                        <button id="clearBin">Clear Bin</button>
                    </div>
                    <div id="takeList" class="bin"></div>
                </div>
            </div>
        </div>

        <!-- FOOTER -->
        <div class="foot glass">
            <div class="left">
                <button id="recBtn" class="rec">‚óè REC</button>
                <div class="badge2">Take <b id="takeNo">1</b></div>
                <div class="badge2">Slate: <span id="slate">INT LAB / DAY</span></div>
                <div class="badge2">Shortcuts: R (rec), A (anamorphic), L (LUT), ‚Üê/‚Üí FPS, ‚Üë/‚Üì ISO</div>
            </div>
            <div class="roger">
                <button id="micBtn" class="mic" title="Voice (Web Speech)">üéô</button>
                <div class="badge2" id="voiceStatus">Roger: idle</div>
            </div>
            <div class="right">
                <button id="resetBtn">Reset</button>
                <button id="saveBtn" class="prim">Save Settings</button>
            </div>
        </div>
    </div>

    <script>
        /* ---------- Base State ---------- */
        const S = {
            res: '4.6K', fps: 24, aspect: '2.39:1',
            lut: '709', texture: 'Neutral', wb: 5600,
            iso: 800, shutter: 180, anamorphic: 1, nd: 2.0,
            focalLength: 50, aperture: 2.8, focusDistance: 0.5,
            recording: false, tc: { h: 0, m: 0, s: 0, f: 0 }, take: 1,
            sessionId: 'session-1',
            battery: 85, hot: 62, warm: 15, coldTB: 3.0
        };
        const els = {
            resSel: $('#resSel'), fpsSel: $('#fpsSel'), aspSel: $('#aspSel'), guides: $('#guides'),
            useCam: $('#useCam'), cam: $('#cam'), test: $('#testPattern'), vf: $('#vf'),
            bFps: $('#bFps'), bRes: $('#bRes'), bISO: $('#bISO'), bShut: $('#bShut'), bAna: $('#bAna'), bLut: $('#bLut'),
            bFocal: $('#bFocal'), bAperture: $('#bAperture'),
            lutSel: $('#lutSel'), lutFile: $('#lutFile'), texSel: $('#texSel'), wbKel: $('#wbKel'),
            focalLength: $('#focalLength'), aperture: $('#aperture'), focusDistance: $('#focusDistance'),
            peaking: $('#peaking'), grain: $('#grain'), nd: $('#nd'), ndOverlay: $('#ndOverlay'), ndVal: $('#ndVal'),
            lbTop: $('#lbTop'), lbBot: $('#lbBot'), guidesBox: $('#guidesBox'),
            timecode: $('#timecode'), recBtn: $('#recBtn'), takeNo: $('#takeNo'),
            iso: $('#iso'), shutter: $('#shutter'), anaSel: $('#anaSel'), flareChk: $('#flareChk'), peakChk: $('#peakChk'),
            evText: $('#evText'), batBar: $('#batBar'), batText: $('#batText'), volt: $('#volt'),
            hotBar: $('#hotBar'), warmBar: $('#warmBar'),
            hotPct: $('#hotPct'), warmPct: $('#warmPct'), coldTB: $('#coldTB'),
            projName: $('#projName'), clipId: $('#clipId'),
            micBtn: $('#micBtn'), voiceStatus: $('#voiceStatus'),
            resetBtn: $('#resetBtn'), saveBtn: $('#saveBtn'),
            takeList: $('#takeList'), chooseDir: $('#chooseDir'), clearBin: $('#clearBin'),
            sessionId: $('#sessionId'), connectBtn: $('#connectBtn'), disconnectBtn: $('#disconnectBtn'), multiCamPreview: $('#multiCamPreview'),
            flareOverlay: $('#flareOverlay')
        };
        function $(q) { return document.querySelector(q) }
        function clamp(n, min, max) { return Math.max(min, Math.min(max, n)) }
        function tcStr() { const z = n => String(n).padStart(2, '0'); return `${z(S.tc.h)}:${z(S.tc.m)}:${z(S.tc.s)}:${z(S.tc.f)}` }

        /* ---------- Lens Effects & Overlays with CSS Filters ---------- */
        // Mapping of LUT names to CSS filter strings
        const LUTS = {
            '709': 'contrast(1.15) saturate(1.05)',
            'PQ': 'contrast(1.25) saturate(1.15) brightness(1.08)',
            'FILM': 'contrast(1.22) saturate(1.18) hue-rotate(2deg)',
            'MYTH': 'contrast(1.3) saturate(1.35) brightness(.96)',
            'RAW': 'contrast(1.0) saturate(.9) brightness(1.0)',
            'UPLOAD': '' // Placeholder for custom LUT
        };

        // This function combines all visual effects into a single CSS filter string
        function applyVisualEffects() {
            const lutFilter = LUTS[S.lut] || LUTS['709'];
            const wbFilter = `hue-rotate(${(S.wb - 5600) / 60}deg)`;
            
            // This is a simple, fake DOF. A real implementation is much more complex.
            const dofBlur = (S.aperture < 5.6) ? `blur(${S.aperture * S.aperture}px)` : 'none';
            
            // Apply zoom based on focal length. Reference 50mm as 1x zoom.
            const zoomLevel = S.focalLength / 50; 
            
            // Fixed: Apply both zoom and anamorphic scale together to prevent conflicts
            els.cam.style.transform = `scale(${zoomLevel}) scaleX(${S.anamorphic})`;
            els.cam.style.filter = `${lutFilter} ${wbFilter} ${dofBlur}`;
            els.bLut.textContent = S.lut;
            
            // Update badge text
            els.bFocal.textContent = S.focalLength + 'mm';
            els.bAperture.textContent = 'f/' + S.aperture.toFixed(1);

            // Update anamorphic badge text when this function is called
            els.bAna.textContent = `Anamorphic: ${S.anamorphic === 1 ? 'Off' : S.anamorphic + 'x'}`;
        }

        function applyTexture() {
            const t = S.texture;
            let op = .22, blur = 0;
            if (t === 'Soft') { op = .12; blur = .4 }
            if (t === 'Gritty') { op = .35 }
            if (t === 'Dream') { op = .18; blur = 1 }
            els.grain.style.opacity = op;
            els.grain.style.filter = `blur(${blur}px)`;
        }

        function buildGrain() {
            const c = document.createElement('canvas');
            const s = 256;
            c.width = c.height = s;
            const ctx = c.getContext('2d');
            const img = ctx.createImageData(s, s);
            for (let i = 0; i < img.data.length; i += 4) {
                const v = Math.random() * 255;
                img.data[i] = img.data[i + 1] = img.data[i + 2] = v;
                img.data[i + 3] = 40;
            }
            ctx.putImageData(img, 0, 0);
            els.grain.style.background = `url(${c.toDataURL()}) center/auto repeat`;
        }
        
        // Lens flare effect for anamorphic
        function applyFlare() {
            const isAnamorphic = S.anamorphic > 1;
            els.flareOverlay.classList.toggle('on', isAnamorphic && els.flareChk.checked);
        }

        function applyAspect() {
            const rect = els.vf.getBoundingClientRect();
            const w = rect.width, h = rect.height;
            const target = S.aspect === '2.39:1' ? (w / 2.39) : (S.aspect === '4:3' ? (w * 3 / 4) : (w * 9 / 16));
            const bar = clamp((h - target) / 2, 0, h / 2);
            els.lbTop.style.height = els.guides.checked ? `${bar}px` : '0';
            els.lbBot.style.height = els.guides.checked ? `${bar}px` : '0';
        }
        
        // Removed the redundant applyAnamorphic function.
        // The logic is now part of applyVisualEffects.

        function computeEV() {
            const isoStop = Math.log2(S.iso / 800);
            const shStop = Math.log2(180 / S.shutter);
            const ndStop = -S.nd;
            return isoStop + shStop + ndStop;
        }

        function updateExposure() {
            const ev = computeEV();
            els.evText.textContent = ev.toFixed(2) + ' EV';
            const pct = clamp(50 + ev * 8, 0, 100);
        }

        function applyND() {
            els.ndOverlay.style.opacity = (S.nd / 8).toFixed(3);
            els.ndVal.textContent = S.nd.toFixed(1);
        }

        function refreshBadges() {
            els.bFps.textContent = S.fps + 'fps';
            els.bRes.textContent = S.res;
            els.bISO.textContent = 'EI ' + S.iso;
            els.bShut.textContent = S.shutter + '¬∞';
            els.bFocal.textContent = S.focalLength + 'mm';
            els.bAperture.textContent = 'f/' + S.aperture.toFixed(1);
        }

        /* ---------- Timecode ---------- */
        let tcTimer = null;
        function stepTC() {
            const fps = Number(S.fps);
            S.tc.f++;
            if (S.tc.f >= fps) { S.tc.f = 0; S.tc.s++ }
            if (S.tc.s >= 60) { S.tc.s = 0; S.tc.m++ }
            if (S.tc.m >= 60) { S.tc.m = 0; S.tc.h++ }
            els.timecode.textContent = tcStr();
        }

        /* ---------- Battery & Slices Sim ---------- */
        function tickPower() {
            if (S.recording) {
                S.battery = Math.max(0, S.battery - 0.02);
                if (S.hot < 95) S.hot += 0.01;
            }
            els.batBar.style.width = S.battery.toFixed(2) + '%';
            els.batText.textContent = S.battery.toFixed(0) + '%';
            els.volt.textContent = (22 + (S.battery / 100) * 2.6).toFixed(1) + 'V';
            els.hotBar.style.width = S.hot.toFixed(2) + '%';
            els.warmBar.style.width = S.warm.toFixed(2) + '%';
            els.hotPct.textContent = S.hot.toFixed(0) + '%';
            els.warmPct.textContent = S.warm.toFixed(0) + '%';
            els.coldTB.textContent = S.coldTB.toFixed(1) + 'TB';
        }
        setInterval(tickPower, 250);

        /* ---------- Camera / MediaRecorder ---------- */
        let stream = null, recorder = null, chunks = [];
        let saveDirHandle = null;
        let takes = [];

        function bestMime() {
            const cand = ['video/webm;codecs=vp9,opus', 'video/webm;codecs=vp8,opus', 'video/webm'];
            return cand.find(t => MediaRecorder.isTypeSupported?.(t)) || 'video/webm';
        }

        async function enableCam() {
            try {
                // Request both video and audio
                stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' }, audio: true });
                els.cam.srcObject = stream;
                await els.cam.play();
                els.test.style.display = 'none';
                els.cam.style.visibility = 'visible';
                els.useCam.textContent = 'Camera On';
            } catch (e) {
                console.error('Camera access failed:', e);
                els.test.style.display = 'block';
                els.cam.style.visibility = 'hidden';
                els.useCam.textContent = 'Failed to load camera';
            }
        }

        async function chooseDir() {
            if (!window.showDirectoryPicker) { console.error('Your browser does not support choosing a save folder.'); return; }
            try {
                saveDirHandle = await window.showDirectoryPicker();
            } catch (e) { if (e.name !== 'AbortError') console.error('Folder error:', e); }
        }

        function setRecording(on) {
            if (on) {
                if (!stream) { console.error('Enable camera first.'); return; }
                if (typeof MediaRecorder === 'undefined') { console.error('MediaRecorder is not supported in this browser.'); return; }
                const mt = bestMime();
                chunks = [];
                recorder = new MediaRecorder(stream, { mimeType: mt, videoBitsPerSecond: 6_000_000 }); // ~6 Mbps
                recorder.ondataavailable = e => { if (e.data && e.data.size > 0) chunks.push(e.data); };
                recorder.onstop = handleTakeReady;
                recorder.start(); // single file
                S.recording = true;
                els.recBtn.classList.add('live');
                els.recBtn.textContent = '‚óè LIVE';
                if (tcTimer) clearInterval(tcTimer);
                tcTimer = setInterval(stepTC, 1000 / Number(S.fps));
            } else {
                if (recorder && recorder.state !== 'inactive') recorder.stop();
                S.recording = false;
                els.recBtn.classList.remove('live');
                els.recBtn.textContent = '‚óè REC';
                clearInterval(tcTimer);
                tcTimer = null;
            }
        }

        function safeName(s) { return s.replace(/[^\w\-]+/g, '_'); }
        function takeFilename() {
            const p = safeName(els.projName.textContent || 'Project');
            const c = safeName(els.clipId.textContent || 'Clip');
            const t = String(S.take).padStart(3, '0');
            const ts = new Date().toISOString().replace(/[:.]/g, '-');
            return `${p}_${c}_T${t}_${ts}.webm`;
        }

        async function handleTakeReady() {
            const blob = new Blob(chunks, { type: recorder.mimeType || 'video/webm' });
            const url = URL.createObjectURL(blob);
            const name = takeFilename();
            const meta = { name, size: blob.size, type: blob.type, fps: S.fps, iso: S.iso, shutter: S.shutter, ana: S.anamorphic, lut: S.lut, tc: tcStr() };
            if (saveDirHandle) {
                try {
                    const fileHandle = await saveDirHandle.getFileHandle(name, { create: true });
                    const w = await fileHandle.createWritable();
                    await w.write(blob);
                    await w.close();
                } catch (e) { console.warn('Folder save failed:', e); }
            }
            addTakeToBin({ url, blob, meta });
            if (!saveDirHandle) { triggerDownload(url, name); }
            S.take++;
            els.takeNo.textContent = S.take;
        }

        function triggerDownload(url, name) {
            const a = document.createElement('a');
            a.href = url;
            a.download = name;
            document.body.appendChild(a);
            a.click();
            a.remove();
        }

        function addTakeToBin(t) {
            takes.push(t);
            const row = document.createElement('div');
            row.className = 'take';
            const left = document.createElement('div');
            left.className = 'meta';
            left.innerHTML = `<strong>${t.meta.name}</strong>
                <span>(${(t.meta.size / 1e6).toFixed(2)} MB)</span>
                <span>TC ${t.meta.tc}</span>
                <span>${t.meta.fps}fps</span>
                <span>EI ${t.meta.iso}</span>
                <span>${t.meta.shutter}¬∞</span>
                <span>${t.meta.ana === 1 ? 'Spherical' : t.meta.ana + 'x Anamorphic'}</span>
                <span>LUT ${t.meta.lut}</span>`;
            const vid = document.createElement('video');
            vid.src = t.url;
            vid.controls = true;
            vid.muted = true;
            vid.playsInline = true;
            const dl = document.createElement('button');
            dl.textContent = 'Download';
            dl.onclick = () => triggerDownload(t.url, t.meta.name);
            const del = document.createElement('button');
            del.textContent = 'Remove';
            del.onclick = () => { URL.revokeObjectURL(t.url); row.remove(); };
            row.append(left, dl, del);
            left.style.cursor = 'pointer';
            left.onclick = () => {
                if (row.querySelector('video')) { vid.remove(); } else { row.appendChild(vid); vid.play(); }
            };
            els.takeList.prepend(row);
        }

        /* ---------- Voice (Roger) ---------- */
        let rec = null, recogOn = false;
        function startVoice() {
            const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SR) { els.voiceStatus.textContent = 'Roger: speech not supported'; return }
            if (recogOn) { rec.stop(); recogOn = false; els.micBtn.classList.remove('on'); els.voiceStatus.textContent = 'Roger: idle'; return }
            rec = new SR();
            rec.continuous = true;
            rec.interimResults = false;
            rec.lang = 'en-US';
            rec.onstart = () => { recogOn = true; els.micBtn.classList.add('on'); els.voiceStatus.textContent = 'Roger: listening‚Ä¶' }
            rec.onerror = e => { els.voiceStatus.textContent = 'Roger: ' + e.error }
            rec.onend = () => { recogOn = false; els.micBtn.classList.remove('on'); els.voiceStatus.textContent = 'Roger: idle' }
            rec.onresult = (ev) => {
                const t = ev.results[ev.results.length - 1][0].transcript.trim().toLowerCase();
                els.voiceStatus.textContent = 'Heard: "' + t + '"';
                handleVoice(t);
            };
            rec.start();
        }
        function handleVoice(t) {
            if (/record|start/.test(t)) setRecording(true);
            if (/stop|cut/.test(t)) setRecording(false);
            const m = t.match(/fps\s*(\d{2,3})/);
            if (m) { S.fps = clamp(+m[1], 1, 600); els.fpsSel.value = String(S.fps); refreshBadges(); if (S.recording) { setRecording(false); setRecording(true) } }
            const n = t.match(/iso\s*(\d{2,5})/);
            if (n) { S.iso = clamp(+n[1], 160, 6400); els.iso.value = S.iso; refreshBadges(); updateExposure() }
            if (/anamorphic/.test(t)) {
                if (/1\.3|one point three|1 3/.test(t)) { S.anamorphic = 1.3 } else if (/2x|two/.test(t)) { S.anamorphic = 2 } else { S.anamorphic = 1 }
                els.anaSel.value = String(S.anamorphic);
                applyVisualEffects();
            }
            if (/lut/.test(t)) {
                if (/709|rec/.test(t)) S.lut = '709';
                else if (/pq|hdr/.test(t)) S.lut = 'PQ';
                else if (/film/.test(t)) S.lut = 'FILM';
                else if (/myth/.test(t)) S.lut = 'MYTH';
                else if (/raw|bypass/.test(t)) S.lut = 'RAW';
                els.lutSel.value = S.lut;
                applyVisualEffects();
            }
            const nd = t.match(/nd\s*(\d(\.\d)?)/);
            if (nd) { S.nd = clamp(+nd[1], 2, 7); els.nd.value = S.nd; applyND(); updateExposure() }
        }

        /* ---------- Multi-Cam Sync (Simulated) ---------- */
        let bc;
        let isMaster = false;
        let connectedPeers = {};

        function connectToSession() {
            if (bc) {
                bc.close();
            }
            S.sessionId = els.sessionId.value;
            bc = new BroadcastChannel(S.sessionId);
            isMaster = true; 
            console.log(`Connected to session: ${S.sessionId}. This instance is the MASTER.`);
            els.connectBtn.textContent = "Master";
            els.disconnectBtn.textContent = "Disconnect";
            
            // Listen for other connections
            bc.onmessage = (event) => {
                const message = event.data;
                if (message.type === 'peer_join' && message.peerId !== S.sessionId) {
                    console.log(`Peer joined: ${message.peerId}`);
                    if (!connectedPeers[message.peerId]) {
                        connectedPeers[message.peerId] = true;
                        // Add a placeholder video for the new peer
                        const newVideo = document.createElement('video');
                        newVideo.src = 'https://placehold.co/160x90/5A6B7F/FFFFFF?text=CAM%202';
                        newVideo.autoplay = true;
                        newVideo.muted = true;
                        els.multiCamPreview.appendChild(newVideo);
                    }
                }
            };

            bc.postMessage({ type: 'peer_join', peerId: S.sessionId });
            
            // For this demo, we'll just show placeholders in the multi-cam preview
            // A real multi-cam solution would use WebRTC to share live video streams
            // which is not supported by BroadcastChannel alone.
            const localVid = document.createElement('video');
            localVid.srcObject = stream;
            localVid.autoplay = true;
            localVid.muted = true;
            localVid.playsInline = true;
            els.multiCamPreview.prepend(localVid);
            connectedPeers[S.sessionId] = true;
        }

        function disconnect() {
            if (bc) {
                bc.close();
                bc = null;
                els.multiCamPreview.innerHTML = '';
                connectedPeers = {};
                isMaster = false;
                els.connectBtn.textContent = "Connect to Session";
                els.disconnectBtn.textContent = "Disconnected";
                console.log(`Disconnected from session.`);
            }
        }
        
        /* ---------- Events ---------- */
        els.resSel.onchange = e => { S.res = e.target.value; refreshBadges() }
        els.fpsSel.onchange = e => { S.fps = +e.target.value; refreshBadges(); if (S.recording) { setRecording(false); setRecording(true) } }
        els.aspSel.onchange = e => { S.aspect = e.target.value; applyAspect() }
        els.guides.onchange = applyAspect
        els.useCam.onclick = enableCam
        els.recBtn.onclick = () => setRecording(!S.recording)
        els.lutSel.onchange = e => { 
            S.lut = e.target.value; 
            applyVisualEffects();
            if (S.lut === 'UPLOAD') {
                els.lutFile.click();
            }
        }
        els.lutFile.onchange = async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            S.lut = `Custom LUT (${file.name})`;
            applyVisualEffects();
        };
        els.texSel.onchange = e => { S.texture = e.target.value; applyTexture() }
        els.wbKel.oninput = e => { S.wb = +e.target.value; applyVisualEffects() }
        document.querySelectorAll('button[data-wb]').forEach(b => b.onclick = () => { S.wb = +b.dataset.wb; els.wbKel.value = S.wb; applyVisualEffects() })
        els.nd.oninput = e => { S.nd = +e.target.value; applyND(); updateExposure() }
        els.iso.oninput = e => { S.iso = clamp(+e.target.value, 160, 6400); refreshBadges(); updateExposure() }
        document.querySelector('.incIso').onclick = () => { S.iso = clamp(S.iso + 100, 160, 6400); els.iso.value = S.iso; refreshBadges(); updateExposure() }
        document.querySelector('.decIso').onclick = () => { S.iso = clamp(S.iso - 100, 160, 6400); els.iso.value = S.iso; refreshBadges(); updateExposure() }
        els.shutter.oninput = e => { S.shutter = clamp(+e.target.value, 45, 360); refreshBadges(); updateExposure() }
        document.querySelector('.incSh').onclick = () => { S.shutter = clamp(S.shutter + 5, 45, 360); els.shutter.value = S.shutter; refreshBadges(); updateExposure() }
        document.querySelector('.decSh').onclick = () => { S.shutter = clamp(S.shutter - 5, 45, 360); els.shutter.value = S.shutter; refreshBadges(); updateExposure() }
        els.anaSel.onchange = e => { S.anamorphic = +e.target.value; applyVisualEffects() }
        els.peakChk.onchange = e => { els.peaking.style.opacity = e.target.checked ? .6 : 0 }
        els.flareChk.onchange = e => { applyFlare() }
        els.focalLength.oninput = e => { S.focalLength = +e.target.value; refreshBadges(); applyVisualEffects(); }
        els.aperture.oninput = e => { S.aperture = +e.target.value; refreshBadges(); applyVisualEffects();}
        els.focusDistance.oninput = e => { S.focusDistance = +e.target.value; } // This is just for the slider, no visual effect in this version
        els.micBtn.onclick = startVoice
        els.resetBtn.onclick = () => { localStorage.removeItem('peel_camera_hud'); location.reload() }
        els.saveBtn.onclick = () => { localStorage.setItem('peel_camera_hud', JSON.stringify(S)); blink(els.saveBtn) }
        els.chooseDir.onclick = chooseDir
        els.clearBin.onclick = () => { els.takeList.innerHTML = ''; takes.forEach(t => URL.revokeObjectURL(t.url)); takes = [] }
        els.connectBtn.onclick = connectToSession
        els.disconnectBtn.onclick = disconnect

        function blink(btn) { btn.style.boxShadow = '0 0 12px rgba(122,240,255,.6)'; setTimeout(() => btn.style.boxShadow = '', 500) }

        /* ---------- Keyboard ---------- */
        window.addEventListener('keydown', e => {
            if (e.key.toLowerCase() === 'r') setRecording(!S.recording);
            if (e.key.toLowerCase() === 'a') {
                const seq = [1, 1.3, 2];
                const i = (seq.indexOf(S.anamorphic) + 1) % seq.length;
                S.anamorphic = seq[i];
                applyVisualEffects();
            }
            if (e.key.toLowerCase() === 'l') {
                const order = ['709', 'PQ', 'FILM', 'MYTH', 'RAW'];
                const i = (order.indexOf(S.lut) + 1) % order.length;
                S.lut = order[i];
                els.lutSel.value = S.lut;
                applyVisualEffects();
            }
            if (e.key === 'ArrowRight') {
                const fps = [24, 25, 30, 48, 60, 120, 600];
                let i = fps.indexOf(S.fps);
                i = (i + 1) % fps.length;
                S.fps = fps[i];
                els.fpsSel.value = S.fps;
                refreshBadges();
                if (S.recording) { setRecording(false); setRecording(true) }
            }
            if (e.key === 'ArrowLeft') {
                const fps = [24, 25, 30, 48, 60, 120, 600];
                let i = fps.indexOf(S.fps);
                i = (i - 1 + fps.length) % fps.length;
                S.fps = fps[i];
                els.fpsSel.value = S.fps;
                refreshBadges();
                if (S.recording) { setRecording(false); setRecording(true) }
            }
            if (e.key === 'ArrowUp') { S.iso = clamp(S.iso + 100, 160, 6400); els.iso.value = S.iso; refreshBadges(); updateExposure() }
            if (e.key === 'ArrowDown') { S.iso = clamp(S.iso - 100, 160, 6400); els.iso.value = S.iso; refreshBadges(); updateExposure() }
        });

        /* ---------- Init ---------- */
        // Consolidated the initial visual update calls into a single function for clarity and bug prevention.
        function updateAllVisuals() {
            refreshBadges();
            applyVisualEffects();
            applyTexture();
            applyND();
            applyAspect();
            buildGrain();
            applyFlare();
            updateExposure();
        }

        function load() {
            try {
                const M = JSON.parse(localStorage.getItem('peel_camera_hud') || 'null');
                if (M) Object.assign(S, M);
            } catch { }
            els.resSel.value = S.res;
            els.fpsSel.value = String(S.fps);
            els.aspSel.value = S.aspect;
            els.lutSel.value = S.lut;
            els.texSel.value = S.texture;
            els.wbKel.value = S.wb;
            els.nd.value = S.nd;
            els.iso.value = S.iso;
            els.shutter.value = S.shutter;
            els.anaSel.value = String(S.anamorphic);
            els.focalLength.value = S.focalLength;
            els.aperture.value = S.aperture;
            els.focusDistance.value = S.focusDistance;
            els.sessionId.value = S.sessionId;
            els.batBar.style.width = S.battery + '%';
            els.batText.textContent = S.battery + '%';
            els.hotPct.textContent = S.hot + '%';
            els.warmPct.textContent = S.warm + '%';
            els.coldTB.textContent = S.coldTB.toFixed(1) + 'TB';

            updateAllVisuals();
            

            // Peaking grid
            els.peaking.style.background = "repeating-linear-gradient(0deg, rgba(100,255,100,.0) 0 8px, rgba(100,255,100,.4) 8px 9px), repeating-linear-gradient(90deg, rgba(100,255,100,.0) 0 8px, rgba(100,255,100,.4) 8px 9px)";
            
            // Anamorphic flare effect
            els.flareOverlay.innerHTML = `
                <svg width="100%" height="100%" viewBox="0 0 100 100" preserveAspectRatio="none">
                    <defs>
                        <linearGradient id="glowGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                            <stop offset="0%" style="stop-color:white;stop-opacity:0" />
                            <stop offset="25%" style="stop-color:white;stop-opacity:0.25" />
                            <stop offset="50%" style="stop-color:white;stop-opacity:0.6" />
                            <stop offset="75%" style="stop-color:white;stop-opacity:0.25" />
                            <stop offset="100%" style="stop-color:white;stop-opacity:0" />
                        </linearGradient>
                    </defs>
                    <rect x="0" y="49.5" width="100" height="1" fill="url(#glowGradient)"/>
                </svg>
            `;
        }
        window.addEventListener('resize', applyAspect);
        load();
    </script>
</body>
</html>
